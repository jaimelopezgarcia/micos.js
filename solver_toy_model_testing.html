<!DOCTYPE html>
<html>
<head>
    <title>Physics Solver Testing</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/delaunator@5.0.0/delaunator.min.js"></script>

</head>

<style>
    /*
    * lets make a grid of 2 columns main_canvas/plots_panel, and plots_panel will have all its child divs in a row with a scrollbar for 
    * overflow
    */

    body{
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
    }

    .main_canvas{

        grid-gap: 0px;
        padding: 0px;
        
    }

    .svg{
        border: 1px solid black;
        width: 800px;
        height: 800px;
        margin: 0px;
    }

    .slider{
        width: 100%;
        margin-top: 0px;
    }


    .plots_panel{
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(800px, 1fr));
        grid-gap: 1px;
        padding: 1px;
        overflow: auto;
    }

    .state_info_panel{
        border: 1px solid black;
        width: 300px;
        height: 500px;
        overflow: auto;

        
    }

</style>
<body>
    <script type = "module">
    import {integrateSystem, pendulumSystemConfig,pendulumAnalyticalSolution,
        initState, tumblingBoxSystemConfig,
         tumblingBoxAnalyticalSolution,
          dumbellSlidingOnWallSystemConfig, dumbellSlidingOnWallAnalyticalSolution,
        rollingCircleSystemConfig,rollingCircleAnalyticalSolution } from "./solver.js";
    import {displayObjectInDiv, displayMouseCoords} from "./utils.js";
    import {Drawer} from "./drawing.js"; //drawer.drawState(STATE,VISUAL_OPTIONS,particles_group_id); is the function to draw the state of the system
    import {StateUtils} from "./solver.js";
   /*
        integrateSystem(STATE, nsteps, callbacksActuators = null,
                     method = "SemiEulerActiveSet",
                        PARAMETERS = {})--> returns stateStory, collection of state objects
        default Parameters are
           = {
        "alpha": 5,
        "beta": 5,
        "dt": 0.01,
        "muFriction": 0.0,
        "collisionThreshold": 0.01,
        }

         callbackActuator(state) -> [nparticles,2]
    */  

    function createSystemPanel(nameSystem){
        //lets create a svg to plot the simulation , with an slider to select the time snapshot to see
        //and next to it a plots panel div to plot the graphs of the system
        //main svg
        var main_canvas = document.createElement("div");
        main_canvas.id = nameSystem + "_canvas";
        main_canvas.className = "main_canvas";
        document.body.appendChild(main_canvas);

        // Slider and svg inside main_canvas
        var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.id = nameSystem + "_svg";
        //lets set width and height of the svg

        //lets add the class main_canvas_svg
        svg.setAttribute("class", "svg");

        main_canvas.appendChild(svg);
        let slider = document.createElement("input");
        slider.type = "range";
        slider.min = 0;
        slider.max = 500;
        slider.value = 0;
        slider.className = "slider";
        slider.id = `slider_${nameSystem}`;

        main_canvas.appendChild(slider);

        let plots_panel = document.createElement("div");
        plots_panel.className = "plots_panel";
        main_canvas.appendChild(plots_panel);
        plots_panel.id = `plots_panel_${nameSystem}`;
     }

     function mainPendulum(configParams,PARAMETERS = {}){
        let nameSystem = "pendulum";
        createSystemPanel(nameSystem);
        let svg = document.getElementById(`pendulum_svg`);
        let slider = document.getElementById(`slider_${nameSystem}`);
        let plots_panel = document.getElementById(`plots_panel_${nameSystem}`);

        let stateConfig = pendulumSystemConfig(configParams.thetaO, 0,configParams.g, configParams.L, 1.);//1. is the mass of the pendulum
        let stateStorySim = integrateSystem(stateConfig, 500, null, "SemiEulerActiveSet", PARAMETERS);
        let stateStoryAnalytical = pendulumAnalyticalSolution(configParams.thetaO, configParams.g, configParams.L, stateStorySim.map((state)=>state.time));
        let drawerSim = new Drawer(svg);
        let drawerAnalytical = new Drawer(svg);

        let pendulumParticlesGroupSIMId = "pendulum_particles_SIM"
        let pendulumParticlesGroupAnalyticalId = "pendulum_particles_Analytical"
        
        let VISUAL_OPTIONS_SIM = {"particle_density":0.01, "scale_arrows_force":0.1};
        let VISUAL_OPTIONS_AN = JSON.parse(JSON.stringify(VISUAL_OPTIONS_SIM));
        VISUAL_OPTIONS_AN.particle_density = 0.02;
        VISUAL_OPTIONS_AN.color_particles = "green";

        drawerSim.drawState(stateStorySim[0], pendulumParticlesGroupSIMId, "", VISUAL_OPTIONS_SIM,"","constraintsPendulumSim");
        drawerAnalytical.drawState(stateStoryAnalytical[0], pendulumParticlesGroupAnalyticalId, "", VISUAL_OPTIONS_AN,"","constraintsPendulumAn");

        slider.addEventListener("input", function(){
            let index = parseInt(slider.value);
            drawerSim.drawState(stateStorySim[index], pendulumParticlesGroupSIMId, "", VISUAL_OPTIONS_SIM,"","constraintsPendulumSim");
            drawerAnalytical.drawState(stateStoryAnalytical[index], pendulumParticlesGroupAnalyticalId, "", VISUAL_OPTIONS_AN,"","constraintsPendulumAn");
        });
        

        
     }

    window.onload = function(){
        let configParams = {"thetaO": 0.2, "g": 9.8, "L": 1.0};
        let PARAMETERS = {"alpha": 5, "beta": 5, "dt": 0.01, "muFriction": 0.0, "collisionThreshold": 0.01};
        mainPendulum(configParams, PARAMETERS);
    }
    </script>
</body>
</html>