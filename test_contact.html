<!DOCTYPE html>
<html>
<head>
    <title>Test contact particle surface</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script>
</head>

<style>
    svg{
        border: 1px solid black;
    }
</style>
<body>
    <svg id="canvas" width="800" height="800"></svg>
    <svg id="canvas2" width="800" height="800"></svg>
    <div id = "mousepos Svg2">
        x: 0, y: 0, angle: 0
    </div>

    <script type = "module">
        import {displayObjectInDiv,displayMouseCoords} from './utils.js';
        import {Polygon, CollisionHandler} from './solver.js';
        import {Drawer} from './drawing.js';
        import {makeParticleDraggable} from './dashboardUI.js';
        const DEBUG = true;
        const SVG = document.getElementById("canvas");
        const SVG2 = document.getElementById("canvas2");

        function generateState(){

            let STATE = {

                    "xs": [[-0.2,0.2],[-0.2+0.5,0.2+0.5],[-0.2+0.5,0.2]],
                    "masses": [1,1,1],
                    "collisions": [],
                    "new_collisions": [],//this is for debugging
                    "resolved_collisions": [],//this is for debugging
                    "polygons": [[[0,0],[0.5,0],[0.5,-0.5],[0,-0.5] ]],

                };

            return STATE;
        }

        function updateState(property,val,STATE){
            STATE[property] = val;
            return STATE;
        }

        let STATE = generateState();
        let drawer = new Drawer(SVG);
        drawer.drawState(STATE);


        function collisionCallback(){

                let colHandler = new CollisionHandler();
                let threshold = 0.1;   
                let [collisionsArray, newCollisionsArray, resolvedCollisionsArray] = colHandler.updateCollisions(STATE, threshold);
        
                updateState("collisions",collisionsArray,STATE);
                updateState("new_collisions",newCollisionsArray,STATE);
                updateState("resolved_collisions",resolvedCollisionsArray,STATE);


                //for debugging we'll print wether the particle is inside or outside the polygon
                let polObj = new Polygon(STATE.polygons[0],0);//0 is the index of the polygon
                for (let [i,x] of STATE.xs.entries()){
                    let isInside = polObj.isInteriorPoint(x);
                    if (isInside){
                        console.log(`INSIDE:Particle ${i} is inside the polygon`);
                    }
                
                }
                
            }



        

        function canvas2ModelCallback(points){
            return drawer.canvas2Model(points,true);
        }


        //lets get the particles from the DOM, all are classed as particle
        let particles = document.querySelectorAll(".particle"); 

        function drawStateCallback(){
            drawer.drawState(STATE);
        }

        particles.forEach(particle => {
            makeParticleDraggable(SVG,particle.id,
                                STATE,updateState,
                                canvas2ModelCallback, [drawStateCallback,collisionCallback]
                                )
        });

        window.STATE = STATE;
        displayMouseCoords(SVG, canvas2ModelCallback)
    </script>

</body>
</html>