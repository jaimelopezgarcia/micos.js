<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Control panel dashboard constraint solver</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <div class="panel controls-panel" id="controls-panel">
            <h3 style = "text-align: center; grid-area: 1 / 1 / 2 / 3;">Controls</h3>
            <button id = "step-button">Step</button>
            <button id = "run-button">Run</button>
            <button id = "pause-button">Pause</button>
            <button id = "reset-button">Reset</button>
            <input type="range" id = "states-story" min = "0" max = "0" value = "0"></slider>
            <span id = "states-story-value">0</span>
        </div>

        <div class="panel parameters-panel" id="parameters-panel"></div>
        <div class="panel debug-info-panel" id = "debug-info-panel">Debug Info Panel</div>
        <div class="panel plots-panel" id = "plots-panel"></div>
        <div class="panel main-panel" id = "main-panel">
            <svg class = "display-svg" id = "main-svg" width = "400" height = "400"></svg>
        </div>
        <div class="panel secondary-display-panel" id = "secondary-display-panel">
            <! -- We'll use this panel to display the simulation story -->
            <svg class = "display-svg" id = "secondary-svg" width = "400" height = "400"></svg>
        </div>
        <div class="panel systems-panel" id = "systems-panel">Systems Panel</div>
        <div class="panel visual-options-panel" id = "visual-options-panel">
            <h3 style = "text-align: center; grid-area: 1 / 1 / 2 / 3;">Visual Options</h3>
            <button id = "draw-state-button">Draw State</button>
        </div>
        
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script>


    <script>
        /*
        * Global variables, constants and parameters
        */

        let DEBUG = true;
        let SVG = document.getElementById("main-svg");
        let SECONDARY_SVG = document.getElementById("secondary-svg");

        let PARAMETERS = {
            "g": 9.81,
            "dt": 0.1,
            "alpha": 0.5,
            "beta": 0.5,

        };
        let VISUAL_OPTIONS = {
            "particle_density": 0.01,
            "width_plots": 400,
            "height_plots": 400,
            "scale_arrows_forces":1,

        };

        let OBSERVERS_PARAMETERS = [];

        let STATE = {};
        let STATE_STORY = [];
        let OBSERVERS_STATE = [];
    </script>

    <script type="module">
        /*
        * Build the UI for the dashboard
        */
        import { populateVisualOptionsPanel,
                 populateParametersPanel} from './dashboardUI.js'
        import {displayObjectInDiv} from './utils.js'
        
        let VisualOptionsPanelId = "visual-options-panel";
        populateVisualOptionsPanel(VISUAL_OPTIONS, VisualOptionsPanelId);

        let ParametersPanelId = "parameters-panel";

        populateParametersPanel(PARAMETERS, ParametersPanelId, OBSERVERS_PARAMETERS);

        // DISPLAY PARAMETERS IN DEBUG PANEL
        displayObjectInDiv(PARAMETERS, "debug-info-panel");

        // ADDING OBSERVERS_PARAMETERS

        OBSERVERS_PARAMETERS.push(function(PARAMETERS){
            displayObjectInDiv(PARAMETERS, "debug-info-panel");
        });




    </script>


    <script type = "module">
        import {drawParticles, drawForces, drawConstraints, plotStateStoryPositionsVelocities, Drawer} from './drawing.js'
        import {displayObjectInDiv} from './utils.js'
        import {stepTestSemiEuler, stepSemiEulerNonContact, pendulumSystemConfig,chainSystemConfig,
            doublePendulumSystemConfig, initState } from './solver.js'

        function resetStory(){
            STATE_STORY = [];
            //lets update the slider
            let states_story_slider = document.getElementById("states-story");
            let states_story_value = document.getElementById("states-story-value");
            states_story_slider.max = 0;
            states_story_slider.value = 0;
            states_story_value.innerHTML = 0;

        }


        function addStateToStory(STATE, STATE_STORY){
            //we'll use this fun after a step
            let STATE_COPY = JSON.parse(JSON.stringify(STATE));
            STATE_STORY.push(STATE_COPY);
            //lets include max 20 states in the story
            if (STATE_STORY.length > 60){
                STATE_STORY.shift();
            }
            let states_story_slider = document.getElementById("states-story");
            let states_story_value = document.getElementById("states-story-value");
            states_story_slider.max = STATE_STORY.length - 1;
            states_story_slider.value = STATE_STORY.length - 1;
            states_story_value.innerHTML = STATE_STORY.length - 1;
            

        }
        
        function _updateStateWithParameters(STATE, PARAMETERS){
            // I want State to have a complete explicit description that completely determines dynamics
            //but there will be some redundancy with parameters
            // So a compromise is to have a function that updates the state with the parameters
            // for things like gravity, damping, etc

            //By now we'll update gravity with the parameter g ( the first index of the gravity entry associated value)

            // this is a little hacky, so lets make a reminder debug console.log
            if (DEBUG){
                console.log("UPDATING STATE WITH PARAMETERS, THIS WILL ONLY UPDATE STATE ON  THE UPDATE STATE CALLBACKS, NOT THE PARAMETERS CALLBACKS");
            }

            let g = PARAMETERS.g;
            STATE["gravity"][0] = g;
        }
        function updateState(key, value){
            STATE[key] = value;
            _updateStateWithParameters(STATE, PARAMETERS);
            OBSERVERS_STATE.forEach(observer => observer(STATE));

        }


        function replaceState(new_state){

            STATE = new_state;
            _updateStateWithParameters(STATE, PARAMETERS);
            OBSERVERS_STATE.forEach(observer => observer(STATE));
        }

 

        function getSvgRelativeCoords(svg, xabs, yabs){
            let rect = svg.getBoundingClientRect();
            let [xoffset, yoffset] = [rect.x, rect.y];
            let [xsvg, ysvg] = [xabs - xoffset, yabs - yoffset];
            return [xsvg, ysvg];
}

        function makeParticleDraggable(STATE, SVG, particle_id, particle_idx, drawer){
            /*
            *   Function to make a particle draggable
            *  Assumes that the particle is a circle with a text element inside
            *  And the particle_id last part is the particle_idx
            */
            //lets throw an error if the number after the last _ in the id doesnt match the particle_idx
            let split_id = particle_id.split("_");
            let particle_number = split_id[split_id.length-1];
            if (particle_number != particle_idx){
                throw new Error(`particle_number ${particle_number} does not match particle_idx ${particle_idx}`);
            }
            let particle = document.getElementById(particle_id);
            particle.addEventListener("mousedown", function(event){
                event.preventDefault();
                let [xabs, yabs] = [event.clientX, event.clientY];
                let [xsvg, ysvg] = getSvgRelativeCoords(SVG, xabs, yabs);

                function mouseMoveCallback(event){
                    let [xabs, yabs] = [event.clientX, event.clientY];
                    let [xsvg, ysvg] = getSvgRelativeCoords(SVG, xabs, yabs);
                    particle.querySelector("circle").setAttribute("cx", xsvg);
                    particle.querySelector("circle").setAttribute("cy", ysvg);
                    particle.querySelector("text").setAttribute("x", xsvg);
                    particle.querySelector("text").setAttribute("y", ysvg);

                    let [xnewCanvas, ynewCanvas] =[xsvg, ysvg]
                    let [xnewModel, ynewModel] = drawer.canvas2Model([[xnewCanvas, ynewCanvas]], true)[0];
                    let xs = STATE.xs;
                    xs[particle_idx] = [xnewModel, ynewModel];
                    updateState("xs", xs);
                }
                function mouseUpCallback(event){
                    if (DEBUG){
                        console.log("UPDATED POSITIONS PARTICLE", particle_idx, JSON.stringify(STATE.xs));
                    }   
                    SVG.removeEventListener("mousemove", mouseMoveCallback);
                    SVG.removeEventListener("mouseup", mouseUpCallback);
                }
                SVG.addEventListener("mousemove", mouseMoveCallback);
                SVG.addEventListener("mouseup", mouseUpCallback);
            })

        }
        function MakeParticlesDraggable(STATE, SVG, particles_group_id, drawer){
            let particles = STATE.xs;
            particles.forEach((particle, i) => {
                let particle_id = particles_group_id + "_particle_" + i;
                makeParticleDraggable(STATE, SVG, particle_id, i, drawer);
            })
         }



            function dummyState(){
            //constraints distance is a list of lists of the form [i,j,distance]
            // constraints pin is a list of lists of the form [i,point, distance]
            //collisions is a list of lists of the form [particle_index, edge_index, polygon_index]
            //polygons is a list of polygon objects 

            let state = {
                    "xs":[[-0.2,-0.2],[0,0],[0.5,0.5]],
                    "vs":[[0,0],[0,0],[0,0]],
                    "masses":[1,2,3],
                    "external_forces":[[0.5,0.7],[0,0],[0,0]],
                    "constraint_forces":[[0,0],[0,0],[0,0]],
                    "contact_forces":[[0,0],[0,0],[0,0]],
                    "friction_forces":[[0,0],[0,0],[0,0]],
                    "constraints_distance": [[0,1,1],[1,2,0.5]],
                    "constraints_pin": [[0,[-0.7,-0.4],0.3]],
                    "collisions": [],
                    "new_collisions": [],
                    "removed_collisions": [],
                    "polygons": [],
                    "time": 0,
                }
                return state;
          
                }
            


    let drawer1 = new Drawer(SVG);
    let drawer2 = new Drawer(SECONDARY_SVG);  

    drawer1.drawScaleReference();
    //on window load
    window.onload = function(){

       // let stepFunction = stepTestSemiEuler;
        let stepFunction = stepSemiEulerNonContact;
        //let new_state = dummyState();
        let [thetaO, omegaO, g, L, mass] = [Math.PI/4, 0, 9.81, 0.5, 1];
        let new_state_ = pendulumSystemConfig(thetaO, omegaO, g, L,mass);
        //let [thetaO1, omegaO1, thetaO2, omegaO2, g, L1, L2, mass1, mass2] = [Math.PI/4, 0, Math.PI/4+0.5, 0, 9.81, 0.25, 0.25, 1, 1];
        //let new_state_ = doublePendulumSystemConfig(thetaO1, omegaO1, thetaO2, omegaO2, g, L1, L2, mass1, mass2);
        //let [nparticles,g,L,mass,angle] = [35,9.81,0.2,1,Math.PI/4];
        //let new_state_ = chainSystemConfig(nparticles,g,L,mass,angle);
        window.new_state_ = new_state_;
        let new_state = initState(new_state_,PARAMETERS);// initialization of all forces 
        window.STATE = new_state;
        replaceState(new_state);
        let PARTICLES_GROUP_ID = "particles_group";
        //drawState(SVG,STATE, PARTICLES_GROUP_ID);
        drawer1.drawState(STATE, VISUAL_OPTIONS, PARTICLES_GROUP_ID);
        
        // lets make a copy of the original state for the reset button
        let STATE_0 = JSON.parse(JSON.stringify(STATE));
        MakeParticlesDraggable(STATE, SVG, PARTICLES_GROUP_ID, drawer1);
        window.STATE_0 = STATE_0;
        window.STATE = STATE;





        //lets dump the state in the debug panel and add an observer
        displayObjectInDiv(STATE, "debug-info-panel");

        OBSERVERS_STATE.push(function(STATE){
            displayObjectInDiv(STATE, "debug-info-panel");
        });

        let drawStateButton = document.getElementById("draw-state-button");
        drawStateButton.onclick = function(){
            drawer1.drawState(STATE, VISUAL_OPTIONS, PARTICLES_GROUP_ID);
            
        }

        let stepButton = document.getElementById("step-button");
        function stepCallback(drawer,STATE, PARAMETERS, PARTICLES_GROUP_ID, STATE_STORY){
            if (DEBUG){
                console.log("STEP");
            }
            addStateToStory(STATE, STATE_STORY);
            //stepEuler(STATE, PARAMETERS);
            let newState = stepFunction(STATE, PARAMETERS);
            replaceState(newState);

            drawer.drawState(STATE, VISUAL_OPTIONS, PARTICLES_GROUP_ID);
            //lets plot the state story
            let ParentDivId = "plots-panel";
            plotStateStoryPositionsVelocities(ParentDivId, STATE_STORY, VISUAL_OPTIONS);

        }

        stepButton.onclick = function(){
            stepCallback(drawer1,STATE, PARAMETERS, PARTICLES_GROUP_ID, STATE_STORY);
        }

        //lets add the slider callback, we'll draw the slider selected story state in the secondary svg
        let states_story_slider = document.getElementById("states-story");
        let states_story_value = document.getElementById("states-story-value");

        function sliderCallback(drawer, STATE_STORY, slider,slider_label, PARTICLES_GROUP_ID){
            let index = parseInt(slider.value);
            let state = STATE_STORY[index];
            slider_label.innerHTML = index;
            drawer.drawState(state, VISUAL_OPTIONS, PARTICLES_GROUP_ID);
        }
        states_story_slider.oninput = function(){
            sliderCallback(drawer2, STATE_STORY, states_story_slider, states_story_value, PARTICLES_GROUP_ID);
        }

        let resetButton = document.getElementById("reset-button");
        resetButton.onclick = function(){
            let stateCopy = JSON.parse(JSON.stringify(STATE_0));//to avoid reference problems
            replaceState(stateCopy);
            console.log("STATE RESET","DELETING STORY")
            drawer1.drawState(STATE, VISUAL_OPTIONS, PARTICLES_GROUP_ID);
            resetStory();
            //lets draw the state in the secondary svg
            drawer2.drawState(STATE, VISUAL_OPTIONS, PARTICLES_GROUP_ID);
            //lets clear the plots panel
            let ParentDivId = "plots-panel";
            let parentDiv = document.getElementById(ParentDivId);
            parentDiv.innerHTML = "";
        }
    }


    function svgmousecallback(event,svg, text_display){
            
            let svg_rect = svg.getBoundingClientRect();
            let mouse_position = [event.clientX - svg_rect.left, event.clientY - svg_rect.top];
            let physics_position = drawer1.canvas2Model([mouse_position],true)[0];
            text_display.text(`Canvas coords: ${mouse_position} Physics coords : ${physics_position}`);
        }
    let mousePositionText = d3.select(SVG).append("text")
        .attr("x", 10)
        .attr("y", 20);

    SVG.addEventListener("mousemove", function(event){
        svgmousecallback(event, SVG, mousePositionText);
    });
    </script>


    
</body>
</html>